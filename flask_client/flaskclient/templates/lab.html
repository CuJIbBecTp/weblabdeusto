{% extends "_logged_base.html" %}
{% set title="Lab - " %}
{% block body %}

{{ super() }}

<div class="container" id="reserve-container">
    <div class="text-center">
        <h2>Reserve this experiment</h2>
    </div>

    <div class="row">
        <div class="col-lg-4 col-lg-push-4 text-center well">
            <p>
            <strong>Experiment:</strong> {{ experiment["experiment.name"] }}
            </p>

            <p>
            <strong>Category:</strong> {{ experiment["experiment.category"] }}
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-2 col-lg-offset-4 text-center">
            <a href="#" class="btn btn-primary reserve-btn" id="reserve-btn">Reserve (in Frame)</a>
        </div>
        <div class="col-lg-2 text-center">
            <a href="#" class="btn btn-primary reserve-free-btn" id="reserve-free-btn">Reserve (in Window)</a>
        </div>
    </div>
</div>


<div class="container" id="finish-container" style="display: none">
    <div class="row">
        <div class="col-lg-12 text-center">
            <a href="#" class="btn btn-warning finish-experiment-btn" id="finish-experiment-btn">Finish this experiment</a>
        </div>
    </div>
</div>



    {% if experiment_type == "js" %}
    <div class="" style="padding-top: 20px">
        <div class="">
            <!-- We append a rawgit base URL for testing -->
            <iframe id="exp-frame" width="100%" height="2000 px" src="{{ config["LAB_URL"] + experiment["html.file"] }}" style="border: 0px"></iframe>
        </div>
    </div>
    {% endif %}

{% endblock %}


{% block scripts %}

{{ super() }}

<script type="text/javascript">

function InjectScriptIntoFrame(url) {
    var myIframe = document.getElementById("exp-frame");
    var script = myIframe.contentWindow.document.createElement("script");
    script.async = false;
    script.defer = false;
    script.type = "text/javascript";
    script.src = url;
    myIframe.contentWindow.document.body.appendChild(script);
}

{# Inject the new experiment library and the compatibility layer which automagically is supposed to replace the old one #}
$("#exp-frame").load(function() {
    console.log("Injecting scripts");
    InjectScriptIntoFrame("{{ url_for('static', filename='weblabjs/weblabexp.js', _external=True) }}");
    InjectScriptIntoFrame("{{ url_for('static', filename='weblabjs/weblabexp_compat.js', _external=True) }}");
});


/**
 * Handle certain ui actions when the experiment finishes.
 */
function onReserveDone() {
    $("#reserve-container").slideUp(500);
    $("#finish-container").slideDown(500);
}


/**
 * Handle certain ui actions when the experiment finishes.
 */
function onExperimentFinished() {
    // We should probably show some kind of experiment-finished message.

    $("#reserve-container").slideDown(500);
    $("#finish-container").slideUp(500);

    // Reload the frame.
    // This is particularly important at the moment because the WeblabExp compatibility library
    // does not support any kind of reset besides re-instancing. (and it probably shouldn't support it either).
    $( '#exp-frame' ).attr( 'src', function ( i, val ) { return val; });
}


{# Await for the page #}
$(document).ready(function() {
    // Wait for the reserve.
    $("#reserve-btn").click(function(ev) {
        console.log("RESERVE PROC STARTED");
        var sessionid = "{{ request.cookies.get("sessionid") }}";
        var name = "{{ experiment["experiment.name"] }}";
        var category = "{{ experiment["experiment.category"] }}";
        WeblabWeb.reserve_experiment(sessionid, name, category)
                .done(function(uid, time, initial_config, result) {

                    console.log("RESERVATION DONE");
                    console.log(result);

                    var frame = $("#exp-frame")[0];
                    var wexp = frame.contentWindow.Weblab.getWeblabExp();
                    currentExperiment = wexp; // Save it in a GLOBAL. // TODO: Consider tiding it up.
                    var url = result["url"];
                    wexp.setTargetURL("{{ url_for("redir_json", _external=True) }}");
                    wexp._reservationReady(result["reservation_id"]["id"], result["time"], result["starting_config"]);

                    // Listen also for a dispose, for other ui changes.
                    wexp.onFinish().done(function(f){
                        onExperimentFinished();
                    });

                    // For some ui changes.
                    onReserveDone();
                });
    });


{% if experiment_type == "js" %}

    $("#finish-experiment-btn").click(function(ev){
        currentExperiment.finishExperiment();
    });

    // Wait for the free-mode reserve.
    $("#reserve-free-btn").click(function(ev) {
        console.log("FREE RESERVE PROC STARTED");
        var sessionid = "{{ request.cookies.get("sessionid") }}";
        var name = "{{ experiment["experiment.name"] }}";
        var category = "{{ experiment["experiment.category"] }}";
        WeblabWeb.reserve_experiment(sessionid, name, category)
                .done(function(result) {
                    console.log("RESERVATION DONE");
                    console.log(result);

                    var params = {
                        "r": result["reservation_id"]["id"],
                        "c": result["starting_config"],
                        "t": result["time"],
                        "u": "{{ url_for("redir_json", _external=True) }}",
                        "free": "true"
                    };
                    //var redir = "{{ '//rawgit.com/weblabdeusto/weblabdeusto/new_client/client/src/es/deusto/weblab/public/' + experiment["html.file"] }}";
                    var redir = "{{ config["LAB_URL"] + experiment["html.file"] }}";
                    redir += "?" + $.param(params);
                    console.log(redir);

                    window.location = redir;
                });
    });
{% endif %}
});


</script>
{% endblock %}
