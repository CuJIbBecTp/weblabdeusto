{% extends "_logged_base.html" %}
{% set title="My Experiments" %}
{% block body %}
{{ super() }}


{% raw %}
<script type="x-template" id="template-experiment">
    <div class="experiment-description" data-name="{{ name }}" data-category="{{ category }}">
        <h3>{{ name }}</h3>
        <h4>{{ category }}</h4>
        <div class="row">
            <div class="col-sm-2">
                <img src="http://placehold.it/100x100">
            </div>

            <div class="col-sm-10">
                <p>
                    This is the Archimedes experiment, in which the user can check how the Archimedes
                    principle works in practise by controlling any of several balls which can be remotely
                    immersed into water.
                </p>
            </div>
        </div>
    </div>
</script>
{% endraw %}


<center>
    <h2>My Experiments</h2>
</center>

<div class="container">
    <div class="row">
        <!-- Column for the labs themselves -->
        <div class="column col-xs-9" id="experiment-descriptions">

            <!-- TO BE FILLED WITH EXPERIMENT DESCRIPTIONS -->

        </div>


        <!-- Column for the categories menu -->
        <div class="column col-xs-3">

            <p>
                This should actually contain a menu.
            </p>

        </div>

    </div>
</div>

{% endblock %}


{% block scripts %}
    <script type="text/javascript">
        $(document).ready(function(){
            console.log($.QueryString["sid"]);

            // Load the list of experiments.
            var sid = $.QueryString["sid"];
            WeblabWeb._list_experiments(sid)
                    .done(function(experimentsRawList){
                        console.log("List loaded");
                        console.log(experimentsRawList);

                        var experiments = buildExperimentsDictionary(experimentsRawList);
                        var experimentTemplate = $("#template-experiment").html();
                        Mustache.parse(experimentTemplate);

                        $.each(experiments, function(category_name, category) {
                            $.each(category, function(experiment_name, experiment) {
                                console.log(experimentTemplate);
                                var experimentRendered = Mustache.render(experimentTemplate, {
                                    "name": experiment_name,
                                    "category": category_name}
                                );
                                console.log(experimentRendered);
                                $("#experiment-descriptions").append(experimentRendered);
                            });
                        });

                    })
                    .fail(function(ev){
                        console.error("List could not be loaded");
                    });
        });


        //! Builds the Experiments Dictionary.
        //!
        //! @param experimentsList: Raw list of experiments returned by the list_experiements Weblab API.
        function buildExperimentsDictionary(experimentsList) {
            var experiments = {};
            $.each(experimentsList, function(index, expData){
                var category = expData.experiment.category.name;
                if(experiments[category] == undefined) {
                    experiments[category] = {};
                }
                experiments[category][expData.experiment.name] = {
                    "time_allowed": expData.time_allowed
                };
            });

            return experiments;
        }


    </script>
{% endblock %}
