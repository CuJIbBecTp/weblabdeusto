{% extends "_logged_base.html" %}
{% set title="My Experiments" %}
{% block body %}
    {{ super() }}


    {% raw %}
    <script type="x-template" id="template-experiment">
        <div class="experiment-description well" data-name="{{ name }}" data-category="{{ category }}">
            <h3>{{ name }}</h3>
            <h4>{{ category }}</h4>

            <div class="row">
                <div class="col-sm-2" style="text-align: center">
                    <img style="display: inline-block" class="img-responsive img-thumbnail" src="{{ experiment_picture }}" width="80" height="100"/>
                </div>

                <div class="col-sm-10">
                    <p>
                        This is the Archimedes experiment, in which the user can check how the Archimedes
                        principle works in practise by controlling any of several balls which can be remotely
                        immersed into water.
                    </p>
                </div>
            </div>
        </div>
    </script>

    <script type="x-template" id="template-menu-item">
        <li class="menu-item">
            <a href="#" data-category="{{ category }}">
                {{ category }} ({{ number }})
            </a>
        </li>
    </script>

    {% endraw %}


    <center>
        <h2>My Experiments</h2>
    </center>

    <div class="container">
    <div class="row">
        <!-- Column for the labs themselves -->
        <div class="column col-xs-9" id="experiment-descriptions">
            <!-- TO BE DYNAMICALLY FILLED WITH EXPERIMENT DESCRIPTIONS -->
        </div>


        <!-- Column for the categories menu -->
        <div class="column col-xs-3 well">

            <div id="wrapper">
                <legend>
                    Filter by Category
                </legend>

                <!-- Sidebar -->
                <div id="sidebar-wrapper">
                    <ul class="sidebar-nav" id="menu-categories">
                        <!-- CATEGORIES GO HERE AND ARE DYNAMICALLY FILLED -->
                    </ul>
                </div>
                <!-- /#sidebar-wrapper -->
            </div>

        </div>
    </div>

{% endblock %}


{% block scripts %}
    {{ super() }}

    <script type="text/javascript">

        // Maps the configuration of each experiment in a map with keys: experiment@category
        // which also has an "experiment_type" key added.
        function _parse_experiments_config() {
            experiments = {};
            var _exps = configuration.experiments;
            $.each(_exps, function(exp_type, exp_list) {
                $.each(exp_list, function(index, exp_config){
                    var key = exp_config["experiment.name"] + "@" + exp_config["experiment.category"];
                    experiments[key] = exp_config;
                    exp_config.experiment_type = exp_type;
                });
            });
        }

        //! Retrieves the configuration specific to an experiment from the configuration.js.
        //!
        //! @param str exp_name: Name of the experiment.
        //! @param str exp_category: Category of the experiment.
        //! @rtype: str
        function _get_experiment_config(exp_name, exp_category) {
            return experiments[exp_name + "@" + exp_category];
        }

        $(document).ready(function () {
            // Load the list of experiments.

            // Having session strings in an URL is not too good, so commented out for now.
            // var sid = $.QueryString["sid"];

            // Retrieve the sessionid from permanent storage.
            var sid = store.get("sessionid");


            WeblabWeb._list_experiments(sid)
                    .done(function (experimentsRawList) {
                        console.log("List loaded");
                        console.log(experimentsRawList);

                        var experiments = buildExperimentsDictionary(experimentsRawList);
                        var experimentTemplate = $("#template-experiment").html();
                        var categoryMenuItemTemplate = $("#template-menu-item").html();
                        Mustache.parse(experimentTemplate);
                        Mustache.parse(categoryMenuItemTemplate);

                        // Parse the config (from the configuration.js but it is stored internally).
                        _parse_experiments_config();

                        // Load & display every single experiment.
                        $.each(experiments, function (category_name, category) {
                            $.each(category, function (experiment_name, experiment) {

                                var expConfig = _get_experiment_config(experiment_name, category_name);

                                var experimentRendered = Mustache.render(experimentTemplate, {
                                            "name": experiment_name,
                                            "category": category_name,
                                            "experiment_picture": IMAGES_FOLDER + expConfig["experiment.picture"]
                                        }
                                );
                                $("#experiment-descriptions").append(experimentRendered);
                            });
                        });


                        // Load & display the categories in the menu.
                        $.each(experiments, function (category_name, category) {
                            var categoryMenuItemRendered = Mustache.render(categoryMenuItemTemplate, {
                                "category": category_name,
                                "number": Object.keys(category).length
                            });

                            var $categoryMenuItem = $(categoryMenuItemRendered.trim());
                            $("#menu-categories").append($categoryMenuItem);

                            $categoryMenuItem.click(function (ev) {
                                var all_experiments = $(".experiment-description");
                                var cat_experiments = $(".experiment-description[data-category='" + category_name + "']");

                                // If the specified category is already selected, we deselect it and show everything.
                                if ($categoryMenuItem.hasClass("bg-success")) {
                                    $categoryMenuItem.removeClass("bg-success");
                                    all_experiments.fadeIn(500);
                                } else {
                                    var experiments_to_hide = all_experiments.not(cat_experiments);
                                    experiments_to_hide.slideUp(500);
                                    cat_experiments.delay(600).fadeIn(500);

                                    $(".menu-item").removeClass("bg-success");
                                    $categoryMenuItem.addClass("bg-success");
                                }

                            });
                        });

                    })
                    .fail(function (ev) {
                        console.error("List could not be loaded");
                    });
        });


        //! Builds the Experiments Dictionary.
        //!
        //! @param experimentsList: Raw list of experiments returned by the list_experiements Weblab API.
        function buildExperimentsDictionary(experimentsList) {
            var experiments = {};
            $.each(experimentsList, function (index, expData) {
                var category = expData.experiment.category.name;
                if (experiments[category] == undefined) {
                    experiments[category] = {};
                }
                experiments[category][expData.experiment.name] = {
                    "time_allowed": expData.time_allowed
                };
            });

            return experiments;
        }


    </script>
{% endblock %}
